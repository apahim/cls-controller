apiVersion: cls.redhat.com/v1alpha1
kind: ControllerConfig
metadata:
  name: {{ .Values.controller.name }}
  namespace: {{ .Values.controller.namespace }}
spec:
  name: "{{ .Values.controller.name }}"
  description: "Creates resources on remote clusters using kubeconfig from secrets"
  target:
    type: "kube-api"
    authMethod: "workload-identity"
    secretRef:
      name: "{{ .Values.remoteCluster.secretName }}"

  resources:
    - name: "namespace"
      description: "Create a namespace to host the HostedCluster resource"
      resourceManagement:
        updateStrategy: "in_place"
      template: |
        apiVersion: v1
        kind: Namespace
        metadata:
          name: clusters-{{`{{ .cluster.id }}`}}
    - name: "pull-secret"
      description: "Create ExternalSecret for OpenShift pull secret from GCP Secret Manager"
      resourceManagement:
        updateStrategy: "in_place"
      template: |
        apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: {{ .Values.pullSecret.name }}
          namespace: clusters-{{`{{ .cluster.id }}`}}
        spec:
          refreshInterval: {{ .Values.pullSecret.refreshInterval }}
          secretStoreRef:
            name: {{ .Values.pullSecret.clusterSecretStoreName }}
            kind: ClusterSecretStore
          target:
            name: {{ .Values.pullSecret.name }}
            creationPolicy: Owner
            template:
              type: kubernetes.io/dockerconfigjson
          data:
            - secretKey: .dockerconfigjson
              remoteRef:
                key: {{ .Values.pullSecret.gcpSecretName | quote }}
    - name: "signing-key-secret"
      description: "Create a Secret containing the service account signing key"
      resourceManagement:
        updateStrategy: "in_place"
      template: |
        apiVersion: v1
        kind: Secret
        metadata:
          name: {{`{{ .cluster.name }}`}}-signing-key
          namespace: clusters-{{`{{ .cluster.id }}`}}
        type: Opaque
        data:
          key: {{`{{ .cluster.spec.serviceAccountSigningKey }}`}}

    - name: "named-certificate"
      description: "Create a HostedCluster named certificate for the API server"
      resourceManagement:
        updateStrategy: "in_place"
      template: |
        apiVersion: cert-manager.io/v1
        kind: Certificate
        metadata:
          name: external-api-cert
          namespace: clusters-{{`{{ .cluster.id }}`}}
        spec:
          subject:
            organizations:
              - "Red Hat - Hypershift"
          usages:
            - server auth
            - client auth
          duration: 2160h    # 90 days - maximum expiration from Let's Encrypt
          renewBefore: 720h  # 30 days before expiration - recommended renewal window
          privateKey:
            algorithm: RSA
            encoding: PKCS1
            size: 2048
            rotationPolicy: Always
          dnsNames:
          {{- $domains := splitList "," .Values.hc_dns_domains }}
          {{- $baseDomain := index $domains 0 | trim }}
          {{`{{- $slug := index (split .cluster.created_by "@") 0 }}`}}
          - "*.{{`{{ .cluster.name }}`}}-{{`{{ $slug }}`}}.{{ $baseDomain }}"
          secretName: external-api-cert
          issuerRef:
            name: public-issuer
            kind: ClusterIssuer
            group: cert-manager.io

    - name: "hostedcluster"
      description: "Create a HostedCluster based on cls-backend cluster specification"
      resourceManagement:
        updateStrategy: "in_place"
      template: |
        apiVersion: hypershift.openshift.io/v1beta1
        kind: HostedCluster
        metadata:
          name: {{`{{ .cluster.name }}`}}
          namespace: clusters-{{`{{ .cluster.id }}`}}
          annotations:
            hypershift.openshift.io/pod-security-admission-label-override: baseline
            hypershift.openshift.io/skip-kas-conflict-san-validation: "true"
            {{- if .Values.hypershift.controlPlaneOperatorImage }}
            hypershift.openshift.io/control-plane-operator-image: {{ .Values.hypershift.controlPlaneOperatorImage }}
            {{- end }}
        spec:
          release:
            image: quay.io/openshift-release-dev/ocp-release:4.20.0-x86_64

          controllerAvailabilityPolicy: {{ .Values.hostedCluster.controllerAvailabilityPolicy }}

          platform:
            {{`{{- if eq .cluster.spec.platform.type "GCP" }}`}}
            type: GCP
            gcp:
              project: {{`{{ .cluster.spec.platform.gcp.projectID }}`}}
              region: {{`{{ .cluster.spec.platform.gcp.region }}`}}
              networkConfig:
                network:
                  name: {{`{{ .cluster.spec.platform.gcp.network }}`}}
                privateServiceConnectSubnet:
                  name: {{`{{ .cluster.spec.platform.gcp.subnet }}`}}
              endpointAccess: {{`{{ .cluster.spec.platform.gcp.endpointAccess | default "Private" }}`}}
              workloadIdentity:
                projectNumber: "{{`{{ .cluster.spec.platform.gcp.workloadIdentity.projectNumber }}`}}"
                poolID: {{`{{ .cluster.spec.platform.gcp.workloadIdentity.poolID }}`}}
                providerID: {{`{{ .cluster.spec.platform.gcp.workloadIdentity.providerID }}`}}
                serviceAccountsEmails:
                  nodePool: {{`{{ .cluster.spec.platform.gcp.workloadIdentity.serviceAccountsRef.nodePoolEmail }}`}}
                  controlPlane: {{`{{ .cluster.spec.platform.gcp.workloadIdentity.serviceAccountsRef.controlPlaneEmail }}`}}
                  cloudController: {{`{{ .cluster.spec.platform.gcp.workloadIdentity.serviceAccountsRef.cloudControllerEmail }}`}}
            {{`{{- else }}`}}
            type: None
            {{`{{- end }}`}}

          pullSecret:
            name: pull-secret

          networking:
            clusterNetwork:
              - cidr: 10.132.0.0/14
            serviceNetwork:
              - cidr: 172.31.0.0/16
            networkType: OVNKubernetes

          {{- $domains := splitList "," .Values.hc_dns_domains }}
          {{- $baseDomain := index $domains 0 | trim }}

          # TODO(GCP-259): Replace this temporary slug with proper slug computation
          # Currently extracting username from created_by email for internal testing only
          # This $slug variable will be replaced by a computed slug in GCP-259

          services:
            {{`{{- $slug := index (split .cluster.created_by "@") 0 }}`}}
            - service: APIServer
              servicePublishingStrategy:
                type: Route
                route:
                  hostname: api.{{`{{ .cluster.name }}`}}-{{`{{ $slug }}`}}.{{ $baseDomain }}
            - service: OAuthServer
              servicePublishingStrategy:
                type: Route
                route:
                  hostname: oauth.{{`{{ .cluster.name }}`}}-{{`{{ $slug }}`}}.{{ $baseDomain }}
            - service: Konnectivity
              servicePublishingStrategy:
                type: Route
            - service: Ignition
              servicePublishingStrategy:
                type: Route

          infraID: {{`{{ .cluster.spec.infraID }}`}}
          clusterID: {{`{{ .cluster.id }}`}}

          dns:
            baseDomain: in.{{`{{ .cluster.name }}`}}-{{`{{ $slug }}`}}.{{ $baseDomain }}
            baseDomainPrefix: ""

          {{`{{- if .cluster.spec.issuerURL }}`}}
          issuerURL: {{`{{ .cluster.spec.issuerURL }}`}}
          {{`{{- end }}`}}

          serviceAccountSigningKey:
            name: {{`{{ .cluster.name }}`}}-signing-key

          capabilities:
            disabled:
              # Disable ImageRegistry as GCS buckets not well supported yet. GCP-235
              - ImageRegistry

          configuration:
            authentication:
              type: OIDC
              oidcProviders:
              - name: google
                issuer:
                  issuerURL: https://accounts.google.com
                  audiences:
                  # gcloud SDK client ID
                  - 32555940559.apps.googleusercontent.com
                claimMappings:
                  username:
                    claim: email
                  groups:
                    # Google Workspace domain → Kubernetes group
                    claim: hd
                    prefix: ""

            {{`{{- $certReady := false }}`}}
            {{`{{- if and .resources (index .resources "named-certificate") }}`}}
              {{`{{- $cert := index .resources "named-certificate" }}`}}
              {{`{{- if and $cert.status $cert.status.conditions }}`}}
                {{`{{- range $cert.status.conditions }}`}}
                  {{`{{- if and (eq .type "Ready") (eq .status "True") }}`}}
                    {{`{{- $certReady = true }}`}}
                  {{`{{- end }}`}}
                {{`{{- end }}`}}
              {{`{{- end }}`}}
            {{`{{- end }}`}}
            {{`{{- if $certReady }}`}}
            apiServer:
              servingCerts:
                namedCertificates:
                  - servingCertificate:
                      name: external-api-cert
          {{`{{- end }}`}}

    - name: "rbac-setup-job"
      description: "Create a Job to configure OIDC RBAC in the hosted cluster"
      resourceManagement:
        updateStrategy: "versioned"  # Required for Jobs (immutable resources)
        newGenerationOnly: true      # Only recreate on generation changes
        keepVersions: 2              # Keep 2 completed versions for history
      template: |
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: "cls-rbac-setup-gen-{{`{{ .cluster.generation }}`}}-{{`{{ .timestamp }}`}}"
          namespace: clusters-{{`{{ .cluster.id }}`}}-{{`{{ .cluster.name }}`}}
        spec:
          ttlSecondsAfterFinished: 300
          backoffLimit: 10
          activeDeadlineSeconds: 1800
          template:
            metadata:
              labels:
                job: rbac-setup
            spec:
              restartPolicy: OnFailure
              serviceAccountName: default
              containers:
              - name: oc
                image: quay.io/openshift/origin-cli:latest
                command:
                - /bin/bash
                - -c
                - |
                  set -euo pipefail

                  echo "Waiting for API server to be fully ready (up to 25 minutes)..."
                  ATTEMPTS=0
                  MAX_ATTEMPTS=150

                  while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
                    if kubectl --kubeconfig=/kubeconfig/kubeconfig get --raw /healthz &>/dev/null; then
                      echo "API server is ready after $((ATTEMPTS * 10)) seconds"
                      break
                    fi
                    ATTEMPTS=$((ATTEMPTS + 1))
                    echo "Attempt $ATTEMPTS/$MAX_ATTEMPTS: API server not ready yet, waiting 10s..."
                    sleep 10
                  done

                  if [ $ATTEMPTS -eq $MAX_ATTEMPTS ]; then
                    echo "ERROR: API server did not become ready after $((MAX_ATTEMPTS * 10)) seconds"
                    exit 1
                  fi

                  echo "Creating ClusterRoleBinding for redhat.com domain..."
                  kubectl --kubeconfig=/kubeconfig/kubeconfig apply -f - <<EOF
                  apiVersion: rbac.authorization.k8s.io/v1
                  kind: ClusterRoleBinding
                  metadata:
                    name: redhat-domain-admins
                  roleRef:
                    apiGroup: rbac.authorization.k8s.io
                    kind: ClusterRole
                    name: cluster-admin
                  subjects:
                  - apiGroup: rbac.authorization.k8s.io
                    kind: Group
                    name: redhat.com
                  - apiGroup: rbac.authorization.k8s.io
                    kind: User
                    name: {{`{{ .cluster.created_by }}`}}
                  EOF

                  echo "ClusterRoleBinding created successfully"

                  echo "Verifying ClusterRoleBinding..."
                  kubectl --kubeconfig=/kubeconfig/kubeconfig get clusterrolebinding redhat-domain-admins -o yaml
                volumeMounts:
                - name: kubeconfig
                  mountPath: /kubeconfig
                  readOnly: true
              volumes:
              - name: kubeconfig
                secret:
                  secretName: service-network-admin-kubeconfig
                  defaultMode: 0600

  statusConditions:
    - name: "Applied"
      status: >-
        {{`{{- if and .resources.namespace (index .resources "pull-secret") (index .resources "signing-key-secret") .resources.hostedcluster -}}`}}
        True
        {{`{{- else -}}`}}
        False
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if and .resources.namespace (index .resources "pull-secret") (index .resources "signing-key-secret") .resources.hostedcluster -}}`}}
        ResourcesCreated
        {{`{{- else -}}`}}
        ResourcesNotCreated
        {{`{{- end }}`}}
      message: >-
        {{`{{- if and .resources.namespace (index .resources "pull-secret") (index .resources "signing-key-secret") .resources.hostedcluster -}}`}}
        All resources created successfully: Namespace clusters-{{`{{ .cluster.id }}`}}, pull-secret, signing-key-secret, and HostedCluster {{`{{ .cluster.name }}`}}
        {{`{{- else -}}`}}
        Waiting for resources (namespace: {{`{{ if .resources.namespace }}✓{{ else }}✗{{ end }}`}}, pull-secret: {{`{{ if (index .resources "pull-secret") }}✓{{ else }}✗{{ end }}`}}, signing-key-secret: {{`{{ if (index .resources "signing-key-secret") }}✓{{ else }}✗{{ end }}`}}, hostedcluster: {{`{{ if .resources.hostedcluster }}✓{{ else }}✗{{ end }}`}})
        {{`{{- end }}`}}

    - name: "Available"
      status: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Available" -}}{{ .status }}{{- $found = true -}}{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}Unknown{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          Unknown
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Available" -}}{{ .reason }}{{- $found = true -}}{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}ConditionNotFound{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          ResourceNotFound
        {{`{{- end }}`}}
      message: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Available" -}}{{ .message }}{{- $found = true -}}{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}Available condition not yet reported by HostedCluster{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          HostedCluster resource not found or not created yet
        {{`{{- end }}`}}

    - name: "Healthy"
      status: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Degraded" -}}`}}
              {{`{{- if eq .status "False" -}}`}}True{{`{{- else -}}`}}False{{`{{- end -}}`}}
              {{`{{- $found = true -}}`}}
            {{`{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}Unknown{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          Unknown
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Degraded" -}}`}}
              {{`{{- if eq .status "False" -}}`}}NotDegraded{{`{{- else -}}{{ .reason }}{{- end -}}`}}
              {{`{{- $found = true -}}`}}
            {{`{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}ConditionNotFound{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          ResourceNotFound
        {{`{{- end }}`}}
      message: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Degraded" -}}`}}
              {{`{{- if eq .status "False" -}}`}}The hosted cluster is healthy and not degraded{{`{{- else -}}{{ .message }}{{- end -}}`}}
              {{`{{- $found = true -}}`}}
            {{`{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}Degraded condition not yet reported by HostedCluster{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          HostedCluster resource not found or not created yet
        {{`{{- end }}`}}

    - name: "APIServer"
      status: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if and .resources.hostedcluster.status.controlPlaneEndpoint .resources.hostedcluster.status.controlPlaneEndpoint.host (ne .resources.hostedcluster.status.controlPlaneEndpoint.host "") (ne .resources.hostedcluster.status.controlPlaneEndpoint.port 0) -}}`}}
        True
          {{`{{- else -}}`}}
        False
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        Unknown
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if and .resources.hostedcluster.status.controlPlaneEndpoint .resources.hostedcluster.status.controlPlaneEndpoint.host (ne .resources.hostedcluster.status.controlPlaneEndpoint.host "") (ne .resources.hostedcluster.status.controlPlaneEndpoint.port 0) -}}`}}
        EndpointReady
          {{`{{- else -}}`}}
        EndpointNotReady
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        ResourceNotFound
        {{`{{- end }}`}}
      message: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if and .resources.hostedcluster.status.controlPlaneEndpoint .resources.hostedcluster.status.controlPlaneEndpoint.host (ne .resources.hostedcluster.status.controlPlaneEndpoint.host "") (ne .resources.hostedcluster.status.controlPlaneEndpoint.port 0) -}}`}}
        https://{{`{{ .resources.hostedcluster.status.controlPlaneEndpoint.host }}`}}:{{`{{ .resources.hostedcluster.status.controlPlaneEndpoint.port }}`}}
          {{`{{- else -}}`}}
        API Server endpoint is being configured
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        HostedCluster resource not found
        {{`{{- end }}`}}

    - name: "OAuthServer"
      status: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if .resources.hostedcluster.status.oauthCallbackURLTemplate -}}`}}
        True
          {{`{{- else -}}`}}
        False
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        Unknown
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if .resources.hostedcluster.status.oauthCallbackURLTemplate -}}`}}
        EndpointReady
          {{`{{- else -}}`}}
        EndpointNotReady
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        ResourceNotFound
        {{`{{- end }}`}}
      message: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if .resources.hostedcluster.status.oauthCallbackURLTemplate -}}`}}
        {{`{{ .resources.hostedcluster.status.oauthCallbackURLTemplate | replace "/oauth2callback/[identity-provider-name]" "" }}`}}
          {{`{{- else -}}`}}
        OAuth Server endpoint is being configured
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        HostedCluster resource not found
        {{`{{- end }}`}}

    - name: "DNS"
      status: >-
        {{`{{- if .resources.hostedcluster -}}`}}
        True
        {{`{{- else -}}`}}
        Unknown
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if .resources.hostedcluster -}}`}}
        DNSConfigured
        {{`{{- else -}}`}}
        ResourceNotFound
        {{`{{- end }}`}}
      message: >-
        {{`{{- if .resources.hostedcluster -}}`}}
        {{`{{- $slug := index (split .cluster.created_by "@") 0 }}`}}
        API: api.{{`{{ .cluster.name }}`}}-{{`{{ $slug }}`}}.{{ $baseDomain }} | Ingress: in.{{`{{ .cluster.name }}`}}-{{`{{ $slug }}`}}.{{ $baseDomain }} | Apps: *.apps.in.{{`{{ .cluster.name }}`}}-{{`{{ $slug }}`}}.{{ $baseDomain }}
        {{`{{- else -}}`}}
        HostedCluster resource not found
        {{`{{- end }}`}}
