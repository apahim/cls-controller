apiVersion: cls.redhat.com/v1alpha1
kind: ControllerConfig
metadata:
  name: {{ .Values.controller.name }}
  namespace: {{ .Values.controller.namespace }}
spec:
  name: "{{ .Values.controller.name }}"
  description: "Creates resources on remote clusters using kubeconfig from secrets"
  target:
    type: "kube-api"
    authMethod: "workload-identity"
    secretRef:
      name: "{{ .Values.remoteCluster.secretName }}"

  resources:
    - name: "hostedcluster"
      description: "Create a HostedCluster based on cls-backend cluster specification"
      resourceManagement:
        updateStrategy: "in_place"
      template: |
        apiVersion: hypershift.openshift.io/v1beta1
        kind: HostedCluster
        metadata:
          name: {{`{{ .cluster.name }}`}}
          namespace: clusters
        spec:
          release:
            image: quay.io/openshift-release-dev/ocp-release:4.14.0-x86_64

          configuration:
            securityContexts:
              restricted: true

          controllerAvailabilityPolicy: SingleReplica

          platform:
            type: None

          pullSecret:
            name: pull-secret

          sshKey:
            name: ssh-key

          networking:
            clusterNetwork:
              - cidr: 10.132.0.0/14
            serviceNetwork:
              - cidr: 172.31.0.0/16
            networkType: OVNKubernetes

          services:
            - service: APIServer
              servicePublishingStrategy:
                type: LoadBalancer
            - service: OAuthServer
              servicePublishingStrategy:
                type: NodePort
                nodePort:
                  address: 0.0.0.0
            - service: Konnectivity
              servicePublishingStrategy:
                type: NodePort
                nodePort:
                  address: 0.0.0.0
            - service: Ignition
              servicePublishingStrategy:
                type: NodePort
                nodePort:
                  address: 0.0.0.0

          infraID: {{`{{ .cluster.id }}`}}

          dns:
            baseDomain: example.com


  statusConditions:
    - name: "Applied"
      status: >-
        {{`{{- if .resources.hostedcluster -}}`}}
        True
        {{`{{- else -}}`}}
        False
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if .resources.hostedcluster -}}`}}
        ResourceCreated
        {{`{{- else -}}`}}
        ResourceNotCreated
        {{`{{- end }}`}}
      message: >-
        {{`{{- if .resources.hostedcluster -}}`}}
        HostedCluster {{`{{ .cluster.name }}`}} created successfully
        {{`{{- else -}}`}}
        HostedCluster {{`{{ .cluster.name }}`}} not yet created
        {{`{{- end }}`}}

    - name: "Available"
      status: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Available" -}}{{ .status }}{{- $found = true -}}{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}Unknown{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          Unknown
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Available" -}}{{ .reason }}{{- $found = true -}}{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}ConditionNotFound{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          ResourceNotFound
        {{`{{- end }}`}}
      message: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Available" -}}{{ .message }}{{- $found = true -}}{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}Available condition not yet reported by HostedCluster{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          HostedCluster resource not found or not created yet
        {{`{{- end }}`}}

    - name: "Healthy"
      status: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Degraded" -}}`}}
              {{`{{- if eq .status "False" -}}`}}True{{`{{- else -}}`}}False{{`{{- end -}}`}}
              {{`{{- $found = true -}}`}}
            {{`{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}Unknown{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          Unknown
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Degraded" -}}`}}
              {{`{{- if eq .status "False" -}}`}}NotDegraded{{`{{- else -}}{{ .reason }}{{- end -}}`}}
              {{`{{- $found = true -}}`}}
            {{`{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}ConditionNotFound{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          ResourceNotFound
        {{`{{- end }}`}}
      message: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Degraded" -}}`}}
              {{`{{- if eq .status "False" -}}`}}The hosted cluster is healthy and not degraded{{`{{- else -}}{{ .message }}{{- end -}}`}}
              {{`{{- $found = true -}}`}}
            {{`{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}Degraded condition not yet reported by HostedCluster{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          HostedCluster resource not found or not created yet
        {{`{{- end }}`}}

    - name: "APIServer"
      status: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if and .resources.hostedcluster.status.controlPlaneEndpoint .resources.hostedcluster.status.controlPlaneEndpoint.host (ne .resources.hostedcluster.status.controlPlaneEndpoint.host "") (ne .resources.hostedcluster.status.controlPlaneEndpoint.port 0) -}}`}}
        True
          {{`{{- else -}}`}}
        False
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        Unknown
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if and .resources.hostedcluster.status.controlPlaneEndpoint .resources.hostedcluster.status.controlPlaneEndpoint.host (ne .resources.hostedcluster.status.controlPlaneEndpoint.host "") (ne .resources.hostedcluster.status.controlPlaneEndpoint.port 0) -}}`}}
        EndpointReady
          {{`{{- else -}}`}}
        EndpointNotReady
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        ResourceNotFound
        {{`{{- end }}`}}
      message: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if and .resources.hostedcluster.status.controlPlaneEndpoint .resources.hostedcluster.status.controlPlaneEndpoint.host (ne .resources.hostedcluster.status.controlPlaneEndpoint.host "") (ne .resources.hostedcluster.status.controlPlaneEndpoint.port 0) -}}`}}
        https://{{`{{ .resources.hostedcluster.status.controlPlaneEndpoint.host }}`}}:{{`{{ .resources.hostedcluster.status.controlPlaneEndpoint.port }}`}}
          {{`{{- else -}}`}}
        API Server endpoint is being configured
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        HostedCluster resource not found
        {{`{{- end }}`}}

    - name: "OAuthServer"
      status: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if .resources.hostedcluster.status.oauthCallbackURLTemplate -}}`}}
        True
          {{`{{- else -}}`}}
        False
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        Unknown
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if .resources.hostedcluster.status.oauthCallbackURLTemplate -}}`}}
        EndpointReady
          {{`{{- else -}}`}}
        EndpointNotReady
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        ResourceNotFound
        {{`{{- end }}`}}
      message: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if .resources.hostedcluster.status.oauthCallbackURLTemplate -}}`}}
        {{`{{ .resources.hostedcluster.status.oauthCallbackURLTemplate | replace "/oauth2callback/[identity-provider-name]" "" }}`}}
          {{`{{- else -}}`}}
        OAuth Server endpoint is being configured
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        HostedCluster resource not found
        {{`{{- end }}`}}