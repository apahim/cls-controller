apiVersion: cls.redhat.com/v1alpha1
kind: ControllerConfig
metadata:
  name: {{ .Values.controller.name }}
  namespace: {{ .Values.controller.namespace }}
spec:
  name: "{{ .Values.controller.name }}"
  description: "Creates resources on remote clusters using kubeconfig from secrets"
  target:
    type: "kube-api"
    authMethod: "workload-identity"
    secretRef:
      name: "{{ .Values.remoteCluster.secretName }}"

  resources:
    - name: "namespace"
      description: "Create a namespace to host the HostedCluster resource"
      resourceManagement:
        updateStrategy: "in_place"
      template: |
        apiVersion: v1
        kind: Namespace
        metadata:
          name: clusters-{{`{{ .cluster.id }}`}}
    - name: "pull-secret"
      description: "Create ExternalSecret for OpenShift pull secret from GCP Secret Manager"
      resourceManagement:
        updateStrategy: "in_place"
      template: |
        apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: {{ .Values.pullSecret.name }}
          namespace: clusters-{{`{{ .cluster.id }}`}}
        spec:
          refreshInterval: {{ .Values.pullSecret.refreshInterval }}
          secretStoreRef:
            name: {{ .Values.pullSecret.clusterSecretStoreName }}
            kind: ClusterSecretStore
          target:
            name: {{ .Values.pullSecret.name }}
            creationPolicy: Owner
            template:
              type: kubernetes.io/dockerconfigjson
          data:
            - secretKey: .dockerconfigjson
              remoteRef:
                key: {{ .Values.pullSecret.gcpSecretName | quote }}
    - name: "signing-key-secret"
      description: "Create a Secret containing the service account signing key"
      resourceManagement:
        updateStrategy: "in_place"
      template: |
        apiVersion: v1
        kind: Secret
        metadata:
          name: {{`{{ .cluster.name }}`}}-signing-key
          namespace: clusters-{{`{{ .cluster.id }}`}}
        type: Opaque
        data:
          key: {{`{{ .cluster.spec.serviceAccountSigningKey }}`}}

    - name: "hostedcluster"
      description: "Create a HostedCluster based on cls-backend cluster specification"
      resourceManagement:
        updateStrategy: "in_place"
      template: |
        apiVersion: hypershift.openshift.io/v1beta1
        kind: HostedCluster
        metadata:
          name: {{`{{ .cluster.name }}`}}
          namespace: clusters-{{`{{ .cluster.id }}`}}
          annotations:
            hypershift.openshift.io/pod-security-admission-label-override: baseline
            {{- if .Values.hypershift.controlPlaneOperatorImage }}
            hypershift.openshift.io/control-plane-operator-image: {{ .Values.hypershift.controlPlaneOperatorImage }}
            {{- end }}
        spec:
          release:
            image: quay.io/openshift-release-dev/ocp-release:4.20.0-x86_64

          controllerAvailabilityPolicy: SingleReplica

          platform:
            {{`{{- if eq .cluster.spec.platform.type "GCP" }}`}}
            type: GCP
            gcp:
              project: {{`{{ .cluster.spec.platform.gcp.projectID }}`}}
              region: {{`{{ .cluster.spec.platform.gcp.region }}`}}
              networkConfig:
                network:
                  name: default
                privateServiceConnectSubnet:
                  name: default
              {{`{{- if .cluster.spec.platform.gcp.workloadIdentity }}`}}
              workloadIdentity:
                projectNumber: "{{`{{ .cluster.spec.platform.gcp.workloadIdentity.projectNumber }}`}}"
                poolID: {{`{{ .cluster.spec.platform.gcp.workloadIdentity.poolID }}`}}
                providerID: {{`{{ .cluster.spec.platform.gcp.workloadIdentity.providerID }}`}}
                {{`{{- if .cluster.spec.platform.gcp.workloadIdentity.serviceAccountsRef }}`}}
                serviceAccountsRef:
                  nodePoolEmail: {{`{{ .cluster.spec.platform.gcp.workloadIdentity.serviceAccountsRef.nodePoolEmail }}`}}
                  controlPlaneEmail: {{`{{ .cluster.spec.platform.gcp.workloadIdentity.serviceAccountsRef.controlPlaneEmail }}`}}
                {{`{{- end }}`}}
              {{`{{- end }}`}}
            {{`{{- else }}`}}
            type: None
            {{`{{- end }}`}}

          pullSecret:
            name: pull-secret

          networking:
            clusterNetwork:
              - cidr: 10.132.0.0/14
            serviceNetwork:
              - cidr: 172.31.0.0/16
            networkType: OVNKubernetes

          services:
            - service: APIServer
              servicePublishingStrategy:
                type: LoadBalancer
            - service: OAuthServer
              servicePublishingStrategy:
                type: NodePort
                nodePort:
                  address: 0.0.0.0
            - service: Konnectivity
              servicePublishingStrategy:
                type: NodePort
                nodePort:
                  address: 0.0.0.0
            - service: Ignition
              servicePublishingStrategy:
                type: NodePort
                nodePort:
                  address: 0.0.0.0

          infraID: {{`{{ .cluster.id }}`}}

          dns:
            baseDomain: {{`{{ .cluster.spec.baseDomain | default "example.com" }}`}}

          {{`{{- if .cluster.spec.issuerURL }}`}}
          issuerURL: {{`{{ .cluster.spec.issuerURL }}`}}
          {{`{{- end }}`}}

          serviceAccountSigningKey:
            name: {{`{{ .cluster.name }}`}}-signing-key

          capabilities:
            disabled:
              # Disable ImageRegistry as GCS buckets not well supported yet. GCP-235
              - ImageRegistry


  statusConditions:
    - name: "Applied"
      status: >-
        {{`{{- if and .resources.namespace (index .resources "pull-secret") (index .resources "signing-key-secret") .resources.hostedcluster -}}`}}
        True
        {{`{{- else -}}`}}
        False
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if and .resources.namespace (index .resources "pull-secret") (index .resources "signing-key-secret") .resources.hostedcluster -}}`}}
        ResourcesCreated
        {{`{{- else -}}`}}
        ResourcesNotCreated
        {{`{{- end }}`}}
      message: >-
        {{`{{- if and .resources.namespace (index .resources "pull-secret") (index .resources "signing-key-secret") .resources.hostedcluster -}}`}}
        All resources created successfully: Namespace clusters-{{`{{ .cluster.id }}`}}, pull-secret, signing-key-secret, and HostedCluster {{`{{ .cluster.name }}`}}
        {{`{{- else -}}`}}
        Waiting for resources (namespace: {{`{{ if .resources.namespace }}✓{{ else }}✗{{ end }}`}}, pull-secret: {{`{{ if (index .resources "pull-secret") }}✓{{ else }}✗{{ end }}`}}, signing-key-secret: {{`{{ if (index .resources "signing-key-secret") }}✓{{ else }}✗{{ end }}`}}, hostedcluster: {{`{{ if .resources.hostedcluster }}✓{{ else }}✗{{ end }}`}})
        {{`{{- end }}`}}

    - name: "Available"
      status: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Available" -}}{{ .status }}{{- $found = true -}}{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}Unknown{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          Unknown
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Available" -}}{{ .reason }}{{- $found = true -}}{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}ConditionNotFound{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          ResourceNotFound
        {{`{{- end }}`}}
      message: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Available" -}}{{ .message }}{{- $found = true -}}{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}Available condition not yet reported by HostedCluster{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          HostedCluster resource not found or not created yet
        {{`{{- end }}`}}

    - name: "Healthy"
      status: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Degraded" -}}`}}
              {{`{{- if eq .status "False" -}}`}}True{{`{{- else -}}`}}False{{`{{- end -}}`}}
              {{`{{- $found = true -}}`}}
            {{`{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}Unknown{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          Unknown
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Degraded" -}}`}}
              {{`{{- if eq .status "False" -}}`}}NotDegraded{{`{{- else -}}{{ .reason }}{{- end -}}`}}
              {{`{{- $found = true -}}`}}
            {{`{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}ConditionNotFound{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          ResourceNotFound
        {{`{{- end }}`}}
      message: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- $found := false -}}`}}
          {{`{{- range .resources.hostedcluster.status.conditions -}}`}}
            {{`{{- if eq .type "Degraded" -}}`}}
              {{`{{- if eq .status "False" -}}`}}The hosted cluster is healthy and not degraded{{`{{- else -}}{{ .message }}{{- end -}}`}}
              {{`{{- $found = true -}}`}}
            {{`{{- end -}}`}}
          {{`{{- end -}}`}}
          {{`{{- if not $found -}}`}}Degraded condition not yet reported by HostedCluster{{`{{- end -}}`}}
        {{`{{- else -}}`}}
          HostedCluster resource not found or not created yet
        {{`{{- end }}`}}

    - name: "APIServer"
      status: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if and .resources.hostedcluster.status.controlPlaneEndpoint .resources.hostedcluster.status.controlPlaneEndpoint.host (ne .resources.hostedcluster.status.controlPlaneEndpoint.host "") (ne .resources.hostedcluster.status.controlPlaneEndpoint.port 0) -}}`}}
        True
          {{`{{- else -}}`}}
        False
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        Unknown
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if and .resources.hostedcluster.status.controlPlaneEndpoint .resources.hostedcluster.status.controlPlaneEndpoint.host (ne .resources.hostedcluster.status.controlPlaneEndpoint.host "") (ne .resources.hostedcluster.status.controlPlaneEndpoint.port 0) -}}`}}
        EndpointReady
          {{`{{- else -}}`}}
        EndpointNotReady
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        ResourceNotFound
        {{`{{- end }}`}}
      message: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if and .resources.hostedcluster.status.controlPlaneEndpoint .resources.hostedcluster.status.controlPlaneEndpoint.host (ne .resources.hostedcluster.status.controlPlaneEndpoint.host "") (ne .resources.hostedcluster.status.controlPlaneEndpoint.port 0) -}}`}}
        https://{{`{{ .resources.hostedcluster.status.controlPlaneEndpoint.host }}`}}:{{`{{ .resources.hostedcluster.status.controlPlaneEndpoint.port }}`}}
          {{`{{- else -}}`}}
        API Server endpoint is being configured
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        HostedCluster resource not found
        {{`{{- end }}`}}

    - name: "OAuthServer"
      status: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if .resources.hostedcluster.status.oauthCallbackURLTemplate -}}`}}
        True
          {{`{{- else -}}`}}
        False
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        Unknown
        {{`{{- end }}`}}
      reason: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if .resources.hostedcluster.status.oauthCallbackURLTemplate -}}`}}
        EndpointReady
          {{`{{- else -}}`}}
        EndpointNotReady
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        ResourceNotFound
        {{`{{- end }}`}}
      message: >-
        {{`{{- if .resources.hostedcluster -}}`}}
          {{`{{- if .resources.hostedcluster.status.oauthCallbackURLTemplate -}}`}}
        {{`{{ .resources.hostedcluster.status.oauthCallbackURLTemplate | replace "/oauth2callback/[identity-provider-name]" "" }}`}}
          {{`{{- else -}}`}}
        OAuth Server endpoint is being configured
          {{`{{- end -}}`}}
        {{`{{- else -}}`}}
        HostedCluster resource not found
        {{`{{- end }}`}}
